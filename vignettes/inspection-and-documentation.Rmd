--- 
title: "Inspection & Documentation" 
author: "Doug Kelkhoff"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Inspection and Documentation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.align='center', 
  fig.width = 6,
  fig.height = 4,
  out.width = '600px', 
  out.height = '400px') 
library(ggpackets)
library(ggplot2)
```

Although there's a lot of power in how eagerly `ggpack` swallows up arguments,
it is also a cause of many potential problems. This stems from a multitude of
reasons stemming from the more tolerant handling of arguments. The primary
concerns are that when passing many arguments through to all the layers of a
`ggplot` construction, warnings for improper arguments need to be occassionally
suppressed. Likewise, as arguments are overwritten by the last enterred
instance, that argument may be quietly suppressed. This can be unintuitive if
not communicated responsibly, so a considerable amount of effort has been spent
to make these actions communicated by default and optionally suppressable.

Before jumping in to the mechanisms in place, let's motivate the issue at hand
with a couple examples of situations where behavior allowed by `ggpackets` may
cause confusion for an end user.

# Standalone plotting

The most common message displayed during packet construction is to indicate when
insufficient information is provided to the ggpackets construction to allow for
independent plotting (plotting without prefacing with `ggplot() + aes(...) + ...
`). This is a completely innocuous message, and is only relevent if it's
desirable to use a `ggpackets` function as a standalone plotting function.

```{r standalone, collapse = TRUE}
my_ggpack <- function(...)
  ggpack(geom_point, ...) + ggpack(geom_line, ...)

my_ggpack()
```

Adding data, as directed, prompts us with a new message:

```{r standalone2, collapse = TRUE}
my_ggpack(data = mtcars)
```

Finally, passing all required aesthetics allows for standalone plotting.

```{r standalone3, collapse = TRUE}
my_ggpack(data = mtcars, x = wt, y = mpg)
```

# Potential for Confusion

## Arguments not taking affect as expected

When arguments are passed to many layers, it might be unclear why it is only
taking effect in a subset of the layers within a plot. In the example below, one
may expect both the bars and errorbars to be affected by the blue fill
parameter. However, because `ggplot2` does not use the fill aesthetic for
errorbars, this argument will not take effect.

```{r confusion1, warning = FALSE, message = FALSE}
my_ggpk <- function(...) {
  ggpack(geom_bar, fun.data = mean_se, ..., stat = 'summary') + 
  ggpack(geom_errorbar, fun.data = mean_se, ..., width = 0.2, stat = 'summary')
}

ggplot(mtcars) + 
  aes(x = am, y = wt) + 
  my_ggpk(fill = 'blue')
```

## Specified arguments being overwritten

If an argument is quitely overwritten with a function, it can cause confusion as
to why their desired parameters are not taking effect. In the following example,
the color of the plot is overwridden within the function call to be set to red.

```{r confusion2, warning = FALSE}
my_ggpk <- function(...) ggpack(geom_point, ..., colour = 'red')

ggplot(mtcars) + 
  aes(x = wt, y = mpg) + 
  my_ggpk(color = 'blue')
```

# Communicating Hidden Behaviors

To address this, ggpackets attempts to be transparent with the ways in which it
is manipulating your input arguments.

## When passing invalid arguments

When `ggpack` is called with parameters that can not be used by the underlying
ggplot call, it will output some debugging information to the console to help
provide some clarity as to why the fill argument takes no effect over the
errobar color.

In this case, the error is thrown when the layer is attempted to be constructed
and captured by the `ggpack` function for display with its output.

```{r communication1, collapse = TRUE}
ggpack(geom_errorbar, fill = 'red')
```

This behavior is largely regulated by the `auto_remove_aes` argument passed to
`ggpack`. 

>By default, arguments will be automatically filtered if a list is provided to
`id` which contains `NULL`. Otherwise, invalid arguments will provide an
explanatory message.

Passing `NULL` in an id list exposes functionality to capture all arguments and
automatically remove irrelevent arguments.

```{r communication2}
my_ggpk <- function(...) {
  ggpack(geom_bar, id = list(NULL, 'bar'),
         fun.data = mean_se, ..., stat = 'summary') + 
  ggpack(geom_errorbar, id = list(NULL, 'errorbar'),
         fun.data = mean_se, ..., width = 0.2, stat = 'summary')
}

ggplot(mtcars) + aes(x = am, y = wt) + my_ggpk(fill = 'blue')
```

In any other case, messages will be produced to indicate which arguments are
being ignored. To disable this functionality, you can manually set the
`auto_remove_aes` parameter to `TRUE`, allowing `ggpack` to filter the arguments
down to only those relevant to the given `Geom` and `Stat` classes.

```{r communication3, collapse = TRUE}
ggpack(geom_errorbar, fill = 'red', auto_remove_aes = TRUE)
```

## Overwritten Parameters

Similarly, `ggpack` allows for multiple arguments of the same name to be passed,
which then get filtered for only the last instance of each parameter for the
ggplot2 layer construction. This behavior is quite contrary to the default
behavior of functions in R and therefore poses a threat of being unintuitive or
difficult to debug.

To address this, `ggpack` exposes fine grained control over what messages are
produced when arguments are overwritten, selecting a set of parameter sources
for which warnings should be produced when those parameters have been
overwritten.

>Sources may include
>
>* '...' ellipses parameters passed through a parent function
>* 'dots' parameters passed through the dots argument
>* 'call' parameters, declared during the `ggpack` call construction

### Ellipses Argument Override

By default, any arguments passed through a parent function ellipses argument
will produce a warning when the parameters passed through the parent function
are overwritten within the function body.

```{r overwriting_params, collapse = TRUE}
my_ggpk <- function(...) ggpack(geom_point, ..., color = 'red')

ggplot(mtcars) + aes(x = wt, y = mpg) + my_ggpk(color = 'blue')
```

This behavior can be disabled by setting the `warn` parameter passed to `ggpack`
to `NULL` or `c()`, indicating that no parameters, regardless of parameter
source, should trigger a console warning.

```{r overwriting_params2}
my_ggpk <- function(...) ggpack(geom_point, ..., color = 'red')

ggplot(mtcars) + aes(x = wt, y = mpg) + my_ggpk(color = 'blue')
```

### `dots` Argument Overrides

Within a function, it's common to manipulate ellipses arguments within the
function body before passing them to the `ggpack` call via the `dots` parameter.
In this situation, it may be necessary to enable warnings for `dots` parameters
that are overwritten. This functionality can be enabled by including the string
`'dots'` in the warn vector.

```{r overwriting_params3, collapse = TRUE}
my_ggpk <- function(c, ...) {
  dots <- list(color = switch(c, r = 'red', g = 'green', b = 'blue'))
  ggpack(geom_point, dots = dots, ..., color = 'red')
}

ggplot(mtcars) + aes(x = wt, y = mpg) + my_ggpk('b')
```

### `call` Argument Overrides

Finally, for the sake of completeness and to make it easier to debug `ggpack`
calls, `warn` can also include the string `"call"` to provide warnings if a
argument is overwritten that was passed directly to the call construction. 

```{r overwriting_params4, collapse = TRUE}
ggpack(geom_point, color = 'red', color = 'blue')
```

# Documenting Possible Parameters

With the versatility of parameters that can be captured with the ellipses
arguments makes documentation of encapsulating functions quite difficult. To
help ease this process, the function `document_ggpk` is provided to parse a
function for calls to `ggpk` and automatically produce roxygen documentation to
describe the passing through of arguments.

```{r document_ggpk1}
document_ggpk(my_ggpk)
```

This function can also be used within a roxygen `@eval` statement, specifying
`prefix = ''` (to omit the `#'` before each line) and optionally can include
`header = FALSE` if you'd prefer to write your own preamble to the itemized
parameter documentation.

```{r document_ggpk2}
#' For example, within roxygen text you could include:
#' @param ... Arguments are passed like this:
#' @eval document_ggpk(my_ggpk, header = FALSE, prefix = '')
document_ggpk(my_ggpk, header = FALSE, prefix = '    ')
```

This function works well for the most streamlined use cases, but there are many
ways where the behavior can be more sophisticated. There are a few features
included to try to address some of these more sophisticated utilizations, though
in most cases they are unnecessary.

In situations where the `dots` parameter ambiguously overwrites arguments, you
will be prompted on whether thos arguments should be considered fixed.
Similarly, if variables are being used to indicate the `id` of a `ggpack`
construction, you will be prompted for what text to use to document that `id`. 